<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bot Detection Test - Place</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0f0f23;
      color: #cccccc;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      color: #00cc00;
      margin-bottom: 20px;
      text-align: center;
    }

    .status {
      padding: 10px;
      margin-bottom: 20px;
      border-radius: 4px;
      text-align: center;
      font-weight: bold;
    }

    .status.connected {
      background: #004400;
      color: #00ff00;
    }

    .status.disconnected {
      background: #440000;
      color: #ff0000;
    }

    .bot-tiers {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .bot-card {
      background: #1a1a2e;
      border: 2px solid #2a2a4e;
      border-radius: 8px;
      padding: 20px;
      transition: border-color 0.3s;
    }

    .bot-card.active {
      border-color: #00cc00;
      box-shadow: 0 0 10px rgba(0, 204, 0, 0.3);
    }

    .bot-card h3 {
      color: #ffffff;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .tier-badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: bold;
    }

    .tier-dumb { background: #cc0000; color: white; }
    .tier-basic { background: #cc6600; color: white; }
    .tier-smart { background: #cccc00; color: black; }
    .tier-human { background: #00cc00; color: black; }

    .bot-card p {
      color: #999;
      font-size: 14px;
      margin-bottom: 15px;
      line-height: 1.5;
    }

    .bot-stats {
      background: #0f0f23;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 15px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }

    .stat-row {
      display: flex;
      justify-content: space-between;
      margin: 5px 0;
    }

    .stat-label {
      color: #666;
    }

    .stat-value {
      color: #00cc00;
      font-weight: bold;
    }

    .stat-value.rejected {
      color: #ff0000;
    }

    button {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 4px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 14px;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-start {
      background: #00cc00;
      color: #000;
    }

    .btn-start:hover:not(:disabled) {
      background: #00ff00;
      transform: scale(1.02);
    }

    .btn-stop {
      background: #cc0000;
      color: white;
    }

    .btn-stop:hover:not(:disabled) {
      background: #ff0000;
      transform: scale(1.02);
    }

    .controls {
      background: #1a1a2e;
      border: 2px solid #2a2a4e;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .control-group {
      margin-bottom: 15px;
    }

    .control-group label {
      display: block;
      color: #00cc00;
      margin-bottom: 5px;
      font-weight: bold;
    }

    .control-group input {
      width: 100%;
      padding: 8px;
      background: #0f0f23;
      border: 1px solid #2a2a4e;
      border-radius: 4px;
      color: #cccccc;
      font-family: 'Courier New', monospace;
    }

    .log {
      background: #0f0f23;
      border: 2px solid #2a2a4e;
      border-radius: 8px;
      padding: 20px;
      height: 300px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }

    .log-entry {
      margin: 5px 0;
      padding: 5px;
      border-left: 3px solid #2a2a4e;
      padding-left: 10px;
    }

    .log-entry.sent {
      border-left-color: #0066cc;
      color: #66aaff;
    }

    .log-entry.received {
      border-left-color: #00cc00;
      color: #66ff66;
    }

    .log-entry.rejected {
      border-left-color: #cc0000;
      color: #ff6666;
    }

    .log-entry.info {
      border-left-color: #cccc00;
      color: #ffff66;
    }

    .timestamp {
      color: #666;
      font-size: 10px;
    }

    .grid-preview {
      display: grid;
      grid-template-columns: repeat(10, 30px);
      gap: 2px;
      margin: 15px 0;
      justify-content: center;
    }

    .pixel {
      width: 30px;
      height: 30px;
      border: 1px solid #2a2a4e;
      border-radius: 2px;
    }

    .env-toggle {
      display: flex;
      gap: 10px;
      align-items: center;
      padding: 10px 15px;
      background: #2a2a2a;
      border-radius: 4px;
      font-size: 12px;
      margin-bottom: 20px;
      justify-content: center;
    }

    .toggle-switch {
      position: relative;
      width: 50px;
      height: 24px;
      background: #4a4a4a;
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .toggle-switch.prod {
      background: #2d5016;
    }

    .toggle-slider {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: #fff;
      border-radius: 50%;
      transition: transform 0.3s;
    }

    .toggle-switch.prod .toggle-slider {
      transform: translateX(26px);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸ¤– Bot Detection Test Suite</h1>
    
    <div class="env-toggle">
      <span>Local</span>
      <div class="toggle-switch" id="envToggle" onclick="toggleEnvironment()">
        <div class="toggle-slider"></div>
      </div>
      <span>Production</span>
    </div>

    <div class="controls">
      <h3 style="margin-bottom: 15px; color: #00cc00;">ðŸŽ¯ Target Configuration</h3>
      <div class="control-group">
        <label>WebSocket URL:</label>
        <input type="text" id="wsUrl" value="ws://localhost:3000">
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <div class="control-group">
          <label>Start X:</label>
          <input type="number" id="startX" value="50" min="0" max="127">
        </div>
        <div class="control-group">
          <label>Start Y:</label>
          <input type="number" id="startY" value="50" min="0" max="127">
        </div>
      </div>
      <p style="color: #666; font-size: 12px; margin-top: 10px;">Each bot creates its own connection automatically</p>
    </div>

    <h2 style="margin: 30px 0 15px 0; color: #00cc00;">ðŸŽ­ Bot Tiers</h2>
    <div class="bot-tiers">
      <!-- Dumb Bot -->
      <div class="bot-card" id="card-dumb">
        <h3>
          <span class="tier-badge tier-dumb">TIER 1</span>
          Dumb Bot
        </h3>
        <p>Clicks exactly every 800ms with zero variance. Most obvious bot pattern - should be caught immediately.</p>
        <div class="bot-stats" id="stats-dumb">
          <div class="stat-row">
            <span class="stat-label">Sent:</span>
            <span class="stat-value">0</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Accepted:</span>
            <span class="stat-value">0</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Rejected:</span>
            <span class="stat-value rejected">0</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Success Rate:</span>
            <span class="stat-value">0%</span>
          </div>
        </div>
        <button class="btn-start" onclick="startBot('dumb')">Start Bot</button>
      </div>

      <!-- Basic Bot -->
      <div class="bot-card" id="card-basic">
        <h3>
          <span class="tier-badge tier-basic">TIER 2</span>
          Basic Bot
        </h3>
        <p>Adds tiny random jitter (Â±20ms) to timing. Still too consistent - should be caught after 10 requests.</p>
        <div class="bot-stats" id="stats-basic">
          <div class="stat-row">
            <span class="stat-label">Sent:</span>
            <span class="stat-value">0</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Accepted:</span>
            <span class="stat-value">0</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Rejected:</span>
            <span class="stat-value rejected">0</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Success Rate:</span>
            <span class="stat-value">0%</span>
          </div>
        </div>
        <button class="btn-start" onclick="startBot('basic')">Start Bot</button>
      </div>

      <!-- Smart Bot -->
      <div class="bot-card" id="card-smart">
        <h3>
          <span class="tier-badge tier-smart">TIER 3</span>
          Smart Bot
        </h3>
        <p>Mimics human timing with moderate variance (Â±100ms). Borderline case - may occasionally pass.</p>
        <div class="bot-stats" id="stats-smart">
          <div class="stat-row">
            <span class="stat-label">Sent:</span>
            <span class="stat-value">0</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Accepted:</span>
            <span class="stat-value">0</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Rejected:</span>
            <span class="stat-value rejected">0</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Success Rate:</span>
            <span class="stat-value">0%</span>
          </div>
        </div>
        <button class="btn-start" onclick="startBot('smart')">Start Bot</button>
      </div>

      <!-- Human-like -->
      <div class="bot-card" id="card-human">
        <h3>
          <span class="tier-badge tier-human">TIER 4</span>
          Human-like
        </h3>
        <p>High variance (Â±300ms) with occasional pauses. Should consistently pass as legitimate user.</p>
        <div class="bot-stats" id="stats-human">
          <div class="stat-row">
            <span class="stat-label">Sent:</span>
            <span class="stat-value">0</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Accepted:</span>
            <span class="stat-value">0</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Rejected:</span>
            <span class="stat-value rejected">0</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Success Rate:</span>
            <span class="stat-value">0%</span>
          </div>
        </div>
        <button class="btn-start" onclick="startBot('human')">Start Bot</button>
      </div>
    </div>

    <h2 style="margin: 30px 0 15px 0; color: #00cc00;">ðŸ“Š Activity Log</h2>
    <div class="log" id="log"></div>
  </div>

  <script>
    const WS_URLS = {
      local: 'ws://localhost:3000',
      production: 'wss://pixie-production-677d.up.railway.app'
    };

    let currentEnv = 'local';
    let activeBots = new Map(); // Each bot will have { ws, interval, x, y, lastSent }
    const botStats = {
      dumb: { sent: 0, accepted: 0, rejected: 0 },
      basic: { sent: 0, accepted: 0, rejected: 0 },
      smart: { sent: 0, accepted: 0, rejected: 0 },
      human: { sent: 0, accepted: 0, rejected: 0 }
    };

    function toggleEnvironment() {
      currentEnv = currentEnv === 'local' ? 'production' : 'local';
      document.getElementById('envToggle').classList.toggle('prod');
      
      // Update the WebSocket URL input field
      document.getElementById('wsUrl').value = WS_URLS[currentEnv];
      
      // Stop all active bots
      activeBots.forEach((botData, tier) => {
        stopBot(tier);
      });
      
      log(`Switched to ${currentEnv} environment: ${WS_URLS[currentEnv]}`, 'info');
    }

    const botConfigs = {
      dumb: {
        name: 'Dumb Bot',
        baseInterval: 800,
        variance: 0,
        color: '#FF0000'
      },
      basic: {
        name: 'Basic Bot',
        baseInterval: 800,
        variance: 20,
        color: '#FF8800'
      },
      smart: {
        name: 'Smart Bot',
        baseInterval: 800,
        variance: 100,
        color: '#FFFF00'
      },
      human: {
        name: 'Human-like',
        baseInterval: 1000,
        variance: 300,
        color: '#00FF00'
      }
    };

    function log(message, type = 'info') {
      const logEl = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      
      const timestamp = new Date().toLocaleTimeString('en-US', { 
        hour12: false, 
        hour: '2-digit', 
        minute: '2-digit', 
        second: '2-digit',
        fractionalSecondDigits: 3
      });
      
      entry.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${message}`;
      logEl.appendChild(entry);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function updateStats(tier) {
      const stats = botStats[tier];
      const statsEl = document.getElementById(`stats-${tier}`);
      const successRate = stats.sent > 0 ? ((stats.accepted / stats.sent) * 100).toFixed(1) : 0;
      
      statsEl.innerHTML = `
        <div class="stat-row">
          <span class="stat-label">Sent:</span>
          <span class="stat-value">${stats.sent}</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Accepted:</span>
          <span class="stat-value">${stats.accepted}</span>
        </div>WS_URLS[currentEnv]
        <div class="stat-row">
          <span class="stat-label">Rejected:</span>
          <span class="stat-value rejected">${stats.rejected}</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Success Rate:</span>
          <span class="stat-value">${successRate}%</span>
        </div>
      `;
    }

    function startBot(tier) {
      if (activeBots.has(tier)) {
        stopBot(tier);
        return;
      }

      const config = botConfigs[tier];
      const startX = parseInt(document.getElementById('startX').value);
      const startY = parseInt(document.getElementById('startY').value);
      const wsUrl = WS_URLS[currentEnv];
      
      let requestCount = 0;
      const maxRequests = 50; // Send 50 requests then stop

      // Create dedicated WebSocket connection for this bot
      const botWs = new WebSocket(wsUrl);

      botWs.onopen = () => {
        log(`${config.name}: Connected with dedicated connection`, 'info');
      };

      botWs.onmessage = (event) => {
        const message = JSON.parse(event.data);
        
        if (message.type === 'init') {
          log(`${config.name}: Received board state`, 'received');
          
          // Start sending paints after init
          const botData = activeBots.get(tier);
          if (botData) {
            botData.sendPaint();
          }
        } else if (message.type === 'update') {
          // Track which bot's paint was accepted
          const botData = activeBots.get(tier);
          if (botData && botData.lastSent && 
              botData.lastSent.x === message.x && 
              botData.lastSent.y === message.y) {
            botStats[tier].accepted++;
            updateStats(tier);
            log(`${config.name}: Paint accepted at (${message.x}, ${message.y})`, 'received');
            botData.lastSent = null;
          }
        }
      };

      botWs.onerror = () => {
        log(`${config.name}: Connection error`, 'rejected');
      };

      botWs.onclose = () => {
        log(`${config.name}: Disconnected`, 'rejected');
        stopBot(tier);
      };

      const botData = {
        ws: botWs,
        interval: null,
        x: startX,
        y: startY,
        lastSent: null,
        requestCount: 0,
        sendPaint: function() {
          if (this.requestCount >= maxRequests) {
            stopBot(tier);
            log(`${config.name}: Completed ${maxRequests} requests`, 'info');
            return;
          }

          if (this.ws.readyState !== WebSocket.OPEN) {
            return;
          }

          // Calculate next interval with variance
          const variance = Math.random() * config.variance * 2 - config.variance;
          const nextInterval = config.baseInterval + variance;

          const x = this.x + (this.requestCount % 5);
          const y = this.y + Math.floor(this.requestCount / 5);
          const color = config.color;

          const paintMsg = {
            type: 'paint',
            x: x,
            y: y,
            color: color
          };

          this.ws.send(JSON.stringify(paintMsg));
          botStats[tier].sent++;
          this.lastSent = { x, y, color, time: Date.now() };
          
          log(`${config.name}: Sent paint (${x}, ${y}) - next in ${nextInterval.toFixed(0)}ms`, 'sent');
          updateStats(tier);

          this.requestCount++;

          // Check for silent rejections after 2 seconds
          setTimeout(() => {
            if (this.lastSent && this.lastSent.x === x && this.lastSent.y === y) {
              botStats[tier].rejected++;
              updateStats(tier);
              log(`${config.name}: Paint REJECTED (silent) at (${x}, ${y})`, 'rejected');
              this.lastSent = null;
            }
          }, 2000);

          // Schedule next paint
          this.interval = setTimeout(() => this.sendPaint(), Math.max(100, nextInterval));
        }
      };

      activeBots.set(tier, botData);
      document.getElementById(`card-${tier}`).classList.add('active');
      document.querySelector(`#card-${tier} button`).textContent = 'Stop Bot';
      document.querySelector(`#card-${tier} button`).className = 'btn-stop';
      
      log(`${config.name}: Starting with dedicated connection (variance: Â±${config.variance}ms)`, 'info');
    }

    function stopBot(tier) {
      const botData = activeBots.get(tier);
      if (botData) {
        clearTimeout(botData.interval);
        activeBots.delete(tier);
        document.getElementById(`card-${tier}`).classList.remove('active');
        document.querySelector(`#card-${tier} button`).textContent = 'Start Bot';
        if (botData.ws) {
          botData.ws.close();
        }
        document.querySelector(`#card-${tier} button`).className = 'btn-start';
        log(`${botConfigs[tier].name}: Stopped`, 'info');
      }
    }

    // Auto-connect on load
    window.addEventListener('load', () => {
      log('Bot Detection Test Suite ready', 'info');
      log('Each bot creates its own dedicated WebSocket connection', 'info');
    });
  </script>
</body>
</html>
